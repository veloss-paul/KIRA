# KIRA GitHub Actions Workflow
# macOS self-hosted runnerì—ì„œ ì‹¤í–‰ë©ë‹ˆë‹¤ (Apple ì½”ë“œ ì‚¬ì´ë‹ í•„ìš”)
# ë¹Œë“œ PC: macOS self-hosted runner (kira-tagsì™€ ë™ì¼í•œ í™˜ê²½)

name: Build and Deploy

on:
  push:
    tags:
      - 'v*'  # íƒœê·¸ê°€ pushë  ë•Œë§Œ ì‹¤í–‰ (ì˜ˆ: v0.9.16)

env:
  NODE_VERSION: "22"

jobs:
  deploy:
    name: Build and Deploy macOS App
    runs-on: self-hosted  # macOS self-hosted runner (Apple ì½”ë“œ ì‚¬ì´ë‹ í•„ìš”)
    timeout-minutes: 120  # Notarization ëŒ€ê¸° ì‹œê°„ ê³ ë ¤

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Load nvm (Node Version Manager)
      - name: Load nvm and verify Node.js
        run: |
          export NVM_DIR="$HOME/.nvm"
          [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
          node --version
          npm --version

      # Keychain unlock (ì½”ë“œ ì‚¬ì´ë‹ ë¹„ë°€ë²ˆí˜¸ íŒì—… ë°©ì§€)
      - name: Unlock Keychain
        run: |
          security unlock-keychain -p "${{ secrets.KEYCHAIN_PASSWORD }}" ~/Library/Keychains/login.keychain-db
          security set-keychain-settings -t 7200 ~/Library/Keychains/login.keychain-db

      # AWS CLI í™•ì¸
      - name: Setup AWS CLI
        run: |
          which aws || brew install awscli
          aws --version

      # Electron ì•± dependencies ì„¤ì¹˜
      - name: Install Electron app dependencies
        run: |
          export NVM_DIR="$HOME/.nvm"
          [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
          cd electron-app && npm ci

      # VitePress dependencies ì„¤ì¹˜
      - name: Install VitePress dependencies
        run: |
          export NVM_DIR="$HOME/.nvm"
          [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
          cd vitepress-app && npm ci

      # íƒœê·¸ì—ì„œ ë²„ì „ ì¶”ì¶œ ë° ì ìš©
      - name: Extract version from tag and update package.json
        run: |
          export NVM_DIR="$HOME/.nvm"
          [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"

          if [ -n "$GITHUB_REF_NAME" ]; then
            # íƒœê·¸ì—ì„œ ë²„ì „ ì¶”ì¶œ (v0.9.16 â†’ 0.9.16)
            VERSION=${GITHUB_REF_NAME#v}
            echo "ğŸ“¦ íƒœê·¸ ë²„ì „: $GITHUB_REF_NAME â†’ $VERSION"

            # Electron ì•± package.json ë²„ì „ ì—…ë°ì´íŠ¸
            cd electron-app
            npm version $VERSION --no-git-tag-version
            echo "   âœ… Electron ì•± ë²„ì „: $VERSION"
            cd ..

            # VitePress ë¬¸ì„œ ë²„ì „ ë§í¬ ì—…ë°ì´íŠ¸
            cd vitepress-app
            node scripts/sync-version.js
            echo "   âœ… VitePress ë¬¸ì„œ ë²„ì „ ë§í¬ ì—…ë°ì´íŠ¸: $VERSION"
            cd ..
          else
            echo "âŒ íƒœê·¸ê°€ ì—†ìŠµë‹ˆë‹¤. íƒœê·¸ pushê°€ í•„ìš”í•©ë‹ˆë‹¤."
            exit 1
          fi

      # deploy.sh ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬ ë° ì‹¤í–‰
      - name: Run deploy script
        env:
          # AWS ìê²© ì¦ëª… ì„¤ì •
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          # Apple ì½”ë“œ ì‚¬ì´ë‹ í™˜ê²½ë³€ìˆ˜ ì„¤ì •
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          # ì¸ì¦ì„œ ì„¤ì • (base64 ì¸ì½”ë”©ëœ p12 íŒŒì¼)
          CSC_LINK: ${{ secrets.CSC_LINK }}
          CSC_KEY_PASSWORD: ${{ secrets.CSC_KEY_PASSWORD }}
        run: |
          export NVM_DIR="$HOME/.nvm"
          [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
          chmod +x deploy.sh
          ./deploy.sh

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-build-${{ github.ref_name }}
          path: |
            electron-app/dist/*.dmg
            electron-app/dist/*.zip
          retention-days: 30
